---
import { Icon } from "astro-icon/components";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";

interface Props {
    id: string;
    name?: string;
    isCollapsed?: boolean;
    collapsedHeight?: string;
    class?: string;
    style?: string;
}

const {
    id,
    name,
    isCollapsed: rawIsCollapsed = false,
    collapsedHeight = "7.5rem",
    style,
    class: className = "",
} = Astro.props;

const isCollapsed = Boolean(rawIsCollapsed);
---

<widget-layout
    data-id={id}
    data-is-collapsed={String(isCollapsed)}
    class:list={["pb-4 card-base", className]}
    style={style}
>
    <div
        class="font-bold transition text-lg text-neutral-900 dark:text-neutral-100 relative ml-8 mt-4 mb-2
           before:w-1 before:h-4 before:rounded-[var(--radius-large)] before:bg-[var(--primary)]
           before:absolute before:left-[-16px] before:top-[5.5px]"
    >
        {name}
    </div>

    <div
        id={id}
        class:list={[
            "collapse-wrapper px-4 overflow-hidden",
            { collapsed: isCollapsed },
        ]}
    >
        <slot />
    </div>

    {
        isCollapsed && (
            <div class="expand-btn px-4 -mb-2">
                <button
                    class="btn-plain rounded-lg w-full h-9"
                    type="button"
                    aria-label={i18n(I18nKey.more)}
                >
                    <div class="text-[var(--primary)] flex items-center justify-center gap-2 -translate-x-2">
                        <Icon
                            name="material-symbols:more-horiz"
                            class="text-[1.75rem]"
                        />
                        {i18n(I18nKey.more)}
                    </div>
                </button>
            </div>
        )
    }
</widget-layout>

<style define:vars={{ collapsedHeight }}>
    .collapsed {
        height: var(--collapsedHeight);
    }
</style>

<script>
    class WidgetLayout extends HTMLElement {
        connectedCallback() {
            if (this.dataset.isCollapsed !== "true") return;

            const id = this.dataset.id;
            if (!id) return;

            const btn = this.querySelector(".expand-btn button");
            const wrapper = this.querySelector("#" + id);

            if (!btn || !wrapper) return;

            btn.addEventListener(
                "click",
                () => {
                    wrapper.classList.remove("collapsed");
                    btn.closest(".expand-btn")?.classList.add("hidden");
                },
                { once: true },
            );
        }
    }

    if (!customElements.get("widget-layout")) {
        customElements.define("widget-layout", WidgetLayout);
    }
</script>
