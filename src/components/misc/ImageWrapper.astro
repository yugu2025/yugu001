---
import path from "node:path";

interface Props {
	id?: string;
	src: string;
	class?: string;
	alt?: string;
	position?: string;
	basePath?: string;
	noDarken?: boolean;
}

import { Image } from "astro:assets";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import { generateImageCover } from "@utils/image-cover";
import { url } from "@utils/url";

const {
	id,
	src,
	alt,
	position = "center",
	basePath = "/",
	noDarken = false,
} = Astro.props;
const className = Astro.props.class;

const isLocal = !(
	src.startsWith("/") ||
	src.startsWith("http") ||
	src.startsWith("https") ||
	src.startsWith("data:")
);
const isPublic = src.startsWith("/");

// TODO temporary workaround for images dynamic import
// https://github.com/withastro/astro/issues/3373
// biome-ignore lint/suspicious/noImplicitAnyLet: <check later>
let img;
if (isLocal) {
	const files = import.meta.glob<ImageMetadata>(
		"../../**/*.{png,jpg,jpeg,gif,svg,webp,avif}",
		{
			import: "default",
		},
	);
	let normalizedPath = path
		.normalize(path.join("../../", basePath, src))
		.replace(/\\/g, "/");
	const file = files[normalizedPath];
	if (!file) {
		console.error(
			`\n[ERROR] Image file not found: ${normalizedPath.replace("../../", "src/")}`,
		);
	}

	if (!file) {
		console.error(
			`\n[ERROR] Image file not found: ${normalizedPath.replace("../../", "src/")}`,
		);
	} else {
		img = await file();
	}
}

let shouldDarken = !noDarken;
let imageCover = null;
if (isLocal && img && !noDarken) {
	const normalizedPath = path
		.normalize(path.join("../../", basePath, src))
		.replace(/\\/g, "/");

	const absolutePath = path.resolve(
		path.join(process.cwd(), "src", normalizedPath.replace("../../", "")),
	);

	if (shouldDarken) {
		imageCover = await generateImageCover(absolutePath);
	}
}

const imageStyle = `object-position: ${position}`;
---

<div
	id={id}
	class:list={[className, "overflow-hidden relative"]}
	data-image-wrapper
>
	<div
		class="placeholder absolute inset-0 animate-pulse bg-neutral-800/40 dark:bg-neutral-700/40"
		aria-hidden="true"
	>
	</div>

	<div
		class="error-message hidden absolute inset-0 items-center justify-center text-sm text-black/50 dark:text-white/50"
	>
		<svg
			xmlns="http://www.w3.org/2000/svg"
			fill="none"
			viewBox="0 0 24 24"
			stroke-width="1.5"
			stroke="currentColor"
			class="w-8 h-8 mb-2 opacity-50"
		>
			<path
				stroke-linecap="round"
				stroke-linejoin="round"
				d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"
			></path>
		</svg>
		<span>{i18n(I18nKey.imageLoadError)}</span>
	</div>

	{
		shouldDarken &&
			(imageCover ? (
				<img
					src={imageCover}
					aria-hidden="true"
					alt=""
					class="transition-all duration-300 absolute inset-0 w-full h-full object-cover pointer-events-none opacity-0 dark:opacity-40"
					style={imageStyle}
				/>
			) : (
				<div class="transition-all duration-300 absolute inset-0 dark:bg-black/30 pointer-events-none" />
			))
	}
	{
		isLocal && img && (
			<Image
				src={img}
				alt={alt || ""}
				class="w-full h-full object-cover opacity-0"
				style={imageStyle}
				loading="lazy"
				data-main-image
			/>
		)
	}
	{
		!isLocal && (
			<img
				src={isPublic ? url(src) : src}
				alt={alt || ""}
				class="w-full h-full object-cover opacity-0"
				style={imageStyle}
				loading="lazy"
				data-main-image
			/>
		)
	}
</div>

<script>
	function setupImageLoad() {
		const wrappers = document.querySelectorAll("[data-image-wrapper]");

		wrappers.forEach((wrapper) => {
			const img = wrapper.querySelector(
				"img[data-main-image]",
			) as HTMLImageElement;
			const placeholder = wrapper.querySelector(".placeholder");
			const errorMessage = wrapper.querySelector(".error-message");

			if (!img || !placeholder || !errorMessage) return;

			function handleLoad() {
				img?.classList.remove("opacity-0");
				placeholder?.classList.add("hidden", "pointer-events-none");
			}

			function handleError() {
				placeholder?.classList.remove("hidden");
				errorMessage?.classList.remove("hidden");
				errorMessage?.classList.add("flex", "flex-col");
			}

			if (img.complete && img.naturalWidth > 0) {
				handleLoad();
			} else if (img.complete && img.naturalWidth === 0) {
				handleError();
			} else {
				img.onload = handleLoad;
				img.onerror = handleError;
			}
		});
	}

	document.addEventListener("astro:page-load", setupImageLoad);
	setupImageLoad();
</script>
